name: Deploy to Render

on:
  push:
    branches: [main]
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã‚‚å¯èƒ½

jobs:
  # ========================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
  # ========================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify deployment start
        run: |
          echo "ðŸš€ Deploying to Render..."
          echo "Frontend: https://langgraph-catalyst-frontend.onrender.com"
          echo "Backend: https://langgraph-catalyst-api.onrender.com"

      # Renderã¯è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é€šçŸ¥ã®ã¿
      # render.yamlã®è¨­å®šã«ã‚ˆã‚Šã€mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹

      - name: Wait for Render deployment
        run: |
          echo "Waiting for Render to deploy..."
          sleep 30  # Renderã®ãƒ“ãƒ«ãƒ‰é–‹å§‹ã¾ã§å¾…æ©Ÿ

      - name: Health check (Backend)
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f https://langgraph-catalyst-api.onrender.com/health; then
              echo "âœ… Backend health check passed!"
              break
            fi
            echo "Waiting for backend to be ready... (attempt $((attempt+1))/$max_attempts)"
            sleep 10
            attempt=$((attempt+1))
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ Backend health check failed after $max_attempts attempts"
            exit 1
          fi

      - name: Health check (Frontend)
        run: |
          if curl -f https://langgraph-catalyst-frontend.onrender.com; then
            echo "âœ… Frontend health check passed!"
          else
            echo "âŒ Frontend health check failed"
            exit 1
          fi

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."

          # APIå¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
          curl -f https://langgraph-catalyst-api.onrender.com/docs || exit 1

          # èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
          response=$(curl -s -o /dev/null -w "%{http_code}" https://langgraph-catalyst-api.onrender.com/api/v1/auth/login)
          if [ "$response" != "422" ] && [ "$response" != "401" ]; then
            echo "âŒ Auth endpoint returned unexpected status: $response"
            exit 1
          fi

          echo "âœ… All smoke tests passed!"

      - name: Deployment summary
        run: |
          echo "# ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Live URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://langgraph-catalyst-frontend.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API**: https://langgraph-catalyst-api.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "- **API Docs**: https://langgraph-catalyst-api.onrender.com/docs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â±ï¸ Deployment Time" >> $GITHUB_STEP_SUMMARY
          echo "- Started: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Author: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®Smokeãƒ†ã‚¹ãƒˆï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰- APIä¸ä½¿ç”¨
  # ========================================
  production-smoke-tests:
    name: Production Smoke Tests (NO API CALLS)
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests on production (NO API CALLS)
        working-directory: frontend
        env:
          PLAYWRIGHT_BASE_URL: https://langgraph-catalyst-frontend.onrender.com
          VITE_API_BASE_URL: https://langgraph-catalyst-api.onrender.com/api/v1
        run: |
          echo "ðŸ§ª Running production smoke tests (NO API CHARGES)"
          npx playwright test --grep "@smoke"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-production
          path: frontend/playwright-report/

      - name: Notify on failure
        if: failure()
        run: |
          echo "# âš ï¸ Production Smoke Tests Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the Playwright report for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ Note: Only smoke tests (authentication, navigation) are run automatically." >> $GITHUB_STEP_SUMMARY
          echo "RAG and Architecture features should be tested manually." >> $GITHUB_STEP_SUMMARY
