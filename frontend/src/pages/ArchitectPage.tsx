import { useState } from 'react';
import { useArchitectStore } from '../store/architectStore';
import { architectApi } from '../api/architect';
import Button from '../components/UI/Button';
import Card from '../components/UI/Card';
import CodeBlock from '../components/CodeBlock/CodeBlock';
import MermaidDiagram from '../components/Mermaid/MermaidDiagram';

const SAMPLE_CHALLENGES = [
  {
    challenge: 'ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã®è‡ªå‹•åŒ–ã‚’å®Ÿç¾ã—ãŸã„ã€‚FAQã¸ã®è‡ªå‹•å›ç­”ã¨ã€è¤‡é›‘ãªå•ã„åˆã‚ã›ã¯äººé–“ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã€‚',
    industry: 'EC',
    constraints: ['æ—¥æœ¬èªå¯¾å¿œå¿…é ˆ', 'æ—¢å­˜ã®Zendeskã¨é€£æº'],
  },
  {
    challenge: 'ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•åŒ–ã€‚ãƒ‡ãƒ¼ã‚¿åé›†ã€å‰å‡¦ç†ã€åˆ†æã€ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’è‡ªå‹•åŒ–ã—ã€ç•°å¸¸å€¤æ¤œå‡ºæ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã—ãŸã„ã€‚',
    industry: 'è£½é€ æ¥­',
    constraints: ['æ—¢å­˜ã®BI toolã¨é€£æº', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†'],
  },
  {
    challenge: 'å¥‘ç´„æ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åŠ¹ç‡åŒ–ã€‚å¥‘ç´„æ›¸ã‹ã‚‰é‡è¦æ¡é …ã‚’æŠ½å‡ºã—ã€ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’è¡Œã„ã€å¼è­·å£«ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã™ã‚‹ä»•çµ„ã¿ã‚’ä½œã‚ŠãŸã„ã€‚',
    industry: 'æ³•å¾‹',
    constraints: ['é«˜ç²¾åº¦ãŒå¿…é ˆ', 'æ©Ÿå¯†æƒ…å ±ã®ä¿è­·'],
  },
];

export default function ArchitectPage() {
  const { result, isLoading, error, setResult, setLoading, setError, clear } = useArchitectStore();
  const [businessChallenge, setBusinessChallenge] = useState('');
  const [industry, setIndustry] = useState('');
  const [constraints, setConstraints] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!businessChallenge.trim() || isLoading) return;

    setError(null);
    setLoading(true);

    try {
      const response = await architectApi.generate({
        business_challenge: businessChallenge.trim(),
        industry: industry.trim() || undefined,
        constraints: constraints.trim() ? constraints.split('\n').map(c => c.trim()).filter(Boolean) : undefined,
      });

      setResult(response);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'æ§‹æˆæ¡ˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };

  const handleSampleChallenge = (sample: typeof SAMPLE_CHALLENGES[0]) => {
    setBusinessChallenge(sample.challenge);
    setIndustry(sample.industry);
    setConstraints(sample.constraints.join('\n'));
  };

  const handleDownload = () => {
    if (!result) return;

    const markdown = `# LangGraphæ§‹æˆæ¡ˆ

## ãƒ“ã‚¸ãƒã‚¹èª²é¡Œ
${businessChallenge}

${industry ? `**æ¥­ç•Œ**: ${industry}\n` : ''}
${constraints ? `**åˆ¶ç´„æ¡ä»¶**:\n${constraints.split('\n').map(c => `- ${c}`).join('\n')}\n` : ''}

---

## èª²é¡Œåˆ†æ

### è¦ç´„
${result.challenge_analysis.summary}

### ä¸»è¦è¦ä»¶
${result.challenge_analysis.key_requirements.map(r => `- ${r}`).join('\n')}

### æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
${result.challenge_analysis.suggested_approach}

### LangGraphãŒé©ã—ã¦ã„ã‚‹ç†ç”±
${result.challenge_analysis.langgraph_fit_reason}

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### Mermaidå›³
\`\`\`mermaid
${result.architecture.mermaid_diagram}
\`\`\`

### ãƒãƒ¼ãƒ‰èª¬æ˜
${result.architecture.node_descriptions.map(node => `
#### ${node.name} (${node.node_id})
**ç›®çš„**: ${node.purpose}
${node.description ? `**è©³ç´°**: ${node.description}\n` : ''}**å…¥åŠ›**: ${node.inputs.join(', ')}
**å‡ºåŠ›**: ${node.outputs.join(', ')}
`).join('\n')}

### ã‚¨ãƒƒã‚¸èª¬æ˜
${result.architecture.edge_descriptions.map(edge => `
- **${edge.from_node} â†’ ${edge.to_node}**${edge.condition ? ` (æ¡ä»¶: ${edge.condition})` : ''}: ${edge.description}
`).join('\n')}

---

## ã‚³ãƒ¼ãƒ‰ä¾‹

${result.code_example.explanation}

\`\`\`${result.code_example.language}
${result.code_example.code}
\`\`\`

---

## ãƒ“ã‚¸ãƒã‚¹å‘ã‘èª¬æ˜

${result.business_explanation}

---

## å®Ÿè£…ã®æ³¨æ„ç‚¹

${result.implementation_notes.map(note => `- ${note}`).join('\n')}

---

*Generated by LangGraph Catalyst*
*Model: ${result.metadata.model}*
*Response Time: ${result.metadata.response_time.toFixed(2)}s*
*Tokens Used: ${result.metadata.tokens_used}*
`;

    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `langgraph-architecture-${Date.now()}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="container mx-auto px-6 py-12">
      {/* Header */}
      <div className="mb-12 animate-fade-in">
        <div className="accent-line-top mb-6" />
        <h1 className="text-5xl font-bold mb-4 leading-tight">
          <span className="bg-gradient-to-r from-[var(--color-accent-secondary)] to-purple-600 text-transparent bg-clip-text">
            æ§‹æˆæ¡ˆç”Ÿæˆ
          </span>
        </h1>
        <p className="text-xl text-[var(--color-text-secondary)] max-w-3xl leading-relaxed">
          ãƒ“ã‚¸ãƒã‚¹èª²é¡Œã‚’å…¥åŠ›ã™ã‚‹ã¨ã€LangGraphã«ã‚ˆã‚‹è§£æ±ºç­–ã‚’ææ¡ˆã—ã¾ã™ã€‚Mermaidå›³ã¨ã‚³ãƒ¼ãƒ‰ä¾‹ã§å…·ä½“çš„ãªå®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æä¾›ã—ã¾ã™ã€‚
        </p>

        {result && (
          <div className="mt-4 flex space-x-4">
            <Button variant="outline" size="sm" onClick={clear}>
              æ–°ã—ã„èª²é¡Œã‚’å…¥åŠ›
            </Button>
            <Button variant="primary" size="sm" onClick={handleDownload}>
              Markdownã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </Button>
          </div>
        )}
      </div>

      {!result ? (
        <div className="grid lg:grid-cols-3 gap-8">
          {/* Input Form */}
          <div className="lg:col-span-2">
            <Card>
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label htmlFor="challenge" className="block text-sm font-bold mb-2 text-[var(--color-accent-primary)]">
                    ãƒ“ã‚¸ãƒã‚¹èª²é¡Œ <span className="text-red-500">*</span>
                  </label>
                  <textarea
                    id="challenge"
                    value={businessChallenge}
                    onChange={(e) => setBusinessChallenge(e.target.value)}
                    placeholder="è§£æ±ºã—ãŸã„ãƒ“ã‚¸ãƒã‚¹èª²é¡Œã‚’å…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„..."
                    className="w-full px-4 py-3 bg-[var(--color-bg-tertiary)] border border-[var(--color-border)] text-[var(--color-text-primary)] placeholder-[var(--color-text-tertiary)] focus:border-[var(--color-accent-primary)] focus:outline-none transition-colors font-mono"
                    rows={5}
                    disabled={isLoading}
                    required
                  />
                </div>

                <div>
                  <label htmlFor="industry" className="block text-sm font-bold mb-2 text-[var(--color-accent-warm)]">
                    æ¥­ç•Œï¼ˆä»»æ„ï¼‰
                  </label>
                  <input
                    type="text"
                    id="industry"
                    value={industry}
                    onChange={(e) => setIndustry(e.target.value)}
                    placeholder="ä¾‹: EC, è£½é€ æ¥­, é‡‘è, åŒ»ç™‚ãªã©"
                    className="w-full px-4 py-3 bg-[var(--color-bg-tertiary)] border border-[var(--color-border)] text-[var(--color-text-primary)] placeholder-[var(--color-text-tertiary)] focus:border-[var(--color-accent-primary)] focus:outline-none transition-colors font-mono"
                    disabled={isLoading}
                  />
                </div>

                <div>
                  <label htmlFor="constraints" className="block text-sm font-bold mb-2 text-[var(--color-accent-warm)]">
                    åˆ¶ç´„æ¡ä»¶ï¼ˆä»»æ„ã€1è¡Œã«1ã¤ï¼‰
                  </label>
                  <textarea
                    id="constraints"
                    value={constraints}
                    onChange={(e) => setConstraints(e.target.value)}
                    placeholder="ä¾‹:&#10;æ—¥æœ¬èªå¯¾å¿œå¿…é ˆ&#10;æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æº&#10;é«˜ç²¾åº¦ãŒå¿…é ˆ"
                    className="w-full px-4 py-3 bg-[var(--color-bg-tertiary)] border border-[var(--color-border)] text-[var(--color-text-primary)] placeholder-[var(--color-text-tertiary)] focus:border-[var(--color-accent-primary)] focus:outline-none transition-colors font-mono"
                    rows={4}
                    disabled={isLoading}
                  />
                </div>

                {error && (
                  <div className="p-3 bg-red-900/20 border border-red-500/50 text-red-400 text-sm">
                    âš ï¸ {error}
                  </div>
                )}

                <Button
                  type="submit"
                  variant="primary"
                  size="lg"
                  className="w-full"
                  isLoading={isLoading}
                  disabled={!businessChallenge.trim() || isLoading}
                >
                  {isLoading ? 'æ§‹æˆæ¡ˆã‚’ç”Ÿæˆä¸­...' : 'æ§‹æˆæ¡ˆã‚’ç”Ÿæˆ'}
                </Button>
              </form>
            </Card>
          </div>

          {/* Sidebar */}
          <div className="lg:col-span-1">
            <Card>
              <h3 className="text-xl font-bold mb-4 flex items-center">
                <span className="text-2xl mr-2">ğŸ’¡</span>
                ã‚µãƒ³ãƒ—ãƒ«èª²é¡Œ
              </h3>
              <div className="space-y-3">
                {SAMPLE_CHALLENGES.map((sample, idx) => (
                  <button
                    key={idx}
                    onClick={() => handleSampleChallenge(sample)}
                    disabled={isLoading}
                    className="w-full text-left px-4 py-3 bg-[var(--color-bg-tertiary)] border border-[var(--color-border)] hover:border-[var(--color-accent-secondary)] transition-all disabled:opacity-50"
                  >
                    <div className="text-sm text-[var(--color-text-primary)] mb-2">
                      {sample.challenge.substring(0, 80)}...
                    </div>
                    <div className="flex flex-wrap gap-2">
                      <span className="px-2 py-1 text-xs bg-[var(--color-accent-secondary)]/20 text-[var(--color-accent-secondary)] border border-[var(--color-accent-secondary)]/30">
                        {sample.industry}
                      </span>
                      {sample.constraints.slice(0, 2).map((c, i) => (
                        <span
                          key={i}
                          className="px-2 py-1 text-xs bg-[var(--color-bg-primary)] text-[var(--color-text-tertiary)] border border-[var(--color-border)]"
                        >
                          {c.substring(0, 15)}...
                        </span>
                      ))}
                    </div>
                  </button>
                ))}
              </div>
            </Card>

            <Card className="mt-6" hover={false}>
              <h3 className="text-lg font-bold mb-3 text-[var(--color-accent-primary)]">
                ğŸ—ï¸ å‡ºåŠ›å†…å®¹
              </h3>
              <ul className="space-y-2 text-sm text-[var(--color-text-secondary)]">
                <li>âœ“ èª²é¡Œåˆ†æã¨è¦ä»¶å®šç¾©</li>
                <li>âœ“ Mermaidå›³ã«ã‚ˆã‚‹ãƒ•ãƒ­ãƒ¼å¯è¦–åŒ–</li>
                <li>âœ“ Pythonã‚³ãƒ¼ãƒ‰ä¾‹</li>
                <li>âœ“ ãƒ“ã‚¸ãƒã‚¹å‘ã‘èª¬æ˜</li>
                <li>âœ“ å®Ÿè£…ã®æ³¨æ„ç‚¹</li>
              </ul>
            </Card>
          </div>
        </div>
      ) : (
        /* Results Display */
        <div className="space-y-8">
          {/* Challenge Analysis */}
          <Card className="animate-fade-in">
            <h2 className="text-2xl font-bold mb-4 flex items-center">
              <span className="text-3xl mr-3">ğŸ”</span>
              èª²é¡Œåˆ†æ
            </h2>

            <div className="space-y-4">
              <div>
                <h3 className="text-lg font-bold mb-2 text-[var(--color-accent-primary)]">è¦ç´„</h3>
                <p className="text-[var(--color-text-secondary)] leading-relaxed">
                  {result.challenge_analysis.summary}
                </p>
              </div>

              <div>
                <h3 className="text-lg font-bold mb-2 text-[var(--color-accent-primary)]">ä¸»è¦è¦ä»¶</h3>
                <ul className="space-y-1 text-[var(--color-text-secondary)]">
                  {result.challenge_analysis.key_requirements.map((req, idx) => (
                    <li key={idx} className="flex items-start">
                      <span className="text-[var(--color-accent-warm)] mr-2">â–¸</span>
                      {req}
                    </li>
                  ))}
                </ul>
              </div>

              <div>
                <h3 className="text-lg font-bold mb-2 text-[var(--color-accent-primary)]">æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</h3>
                <p className="text-[var(--color-text-secondary)] leading-relaxed">
                  {result.challenge_analysis.suggested_approach}
                </p>
              </div>

              <div>
                <h3 className="text-lg font-bold mb-2 text-[var(--color-accent-secondary)]">
                  LangGraphãŒé©ã—ã¦ã„ã‚‹ç†ç”±
                </h3>
                <p className="text-[var(--color-text-secondary)] leading-relaxed">
                  {result.challenge_analysis.langgraph_fit_reason}
                </p>
              </div>
            </div>
          </Card>

          {/* Architecture Diagram */}
          <Card className="animate-fade-in" style={{ animationDelay: '100ms' }}>
            <h2 className="text-2xl font-bold mb-4 flex items-center">
              <span className="text-3xl mr-3">ğŸ“Š</span>
              ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
            </h2>
            <MermaidDiagram chart={result.architecture.mermaid_diagram} />

            {/* Node Descriptions */}
            <div className="mt-6">
              <h3 className="text-lg font-bold mb-3 text-[var(--color-accent-primary)]">ãƒãƒ¼ãƒ‰èª¬æ˜</h3>
              <div className="grid md:grid-cols-2 gap-4">
                {result.architecture.node_descriptions.map((node, idx) => (
                  <div
                    key={idx}
                    className="bg-[var(--color-bg-tertiary)] border border-[var(--color-border)] p-4 rounded"
                  >
                    <div className="font-bold text-[var(--color-accent-warm)] mb-1">
                      {node.name} ({node.node_id})
                    </div>
                    <div className="text-sm text-[var(--color-text-secondary)] mb-2">
                      {node.purpose}
                    </div>
                    {node.description && (
                      <div className="text-xs text-[var(--color-text-tertiary)] mb-2">
                        {node.description}
                      </div>
                    )}
                    <div className="text-xs text-[var(--color-text-tertiary)]">
                      <div>å…¥åŠ›: {node.inputs.join(', ')}</div>
                      <div>å‡ºåŠ›: {node.outputs.join(', ')}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </Card>

          {/* Code Example */}
          <Card className="animate-fade-in" style={{ animationDelay: '200ms' }}>
            <h2 className="text-2xl font-bold mb-4 flex items-center">
              <span className="text-3xl mr-3">ğŸ’»</span>
              å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹
            </h2>
            <p className="text-[var(--color-text-secondary)] mb-4 leading-relaxed">
              {result.code_example.explanation}
            </p>
            <CodeBlock
              code={result.code_example.code}
              language={result.code_example.language}
            />
          </Card>

          {/* Business Explanation */}
          <Card className="animate-fade-in" style={{ animationDelay: '300ms' }}>
            <h2 className="text-2xl font-bold mb-4 flex items-center">
              <span className="text-3xl mr-3">ğŸ“</span>
              ãƒ“ã‚¸ãƒã‚¹å‘ã‘èª¬æ˜
            </h2>
            <p className="text-[var(--color-text-secondary)] leading-relaxed whitespace-pre-wrap">
              {result.business_explanation}
            </p>
          </Card>

          {/* Implementation Notes */}
          <Card className="animate-fade-in" style={{ animationDelay: '400ms' }}>
            <h2 className="text-2xl font-bold mb-4 flex items-center">
              <span className="text-3xl mr-3">âš ï¸</span>
              å®Ÿè£…ã®æ³¨æ„ç‚¹
            </h2>
            <ul className="space-y-2 text-[var(--color-text-secondary)]">
              {result.implementation_notes.map((note, idx) => (
                <li key={idx} className="flex items-start">
                  <span className="text-[var(--color-accent-warm)] mr-2">â–¸</span>
                  {note}
                </li>
              ))}
            </ul>
          </Card>

          {/* Metadata */}
          <div className="text-xs text-[var(--color-text-tertiary)] text-center">
            Model: {result.metadata.model} â€¢ Response Time: {result.metadata.response_time.toFixed(2)}s â€¢ Tokens: {result.metadata.tokens_used}
          </div>
        </div>
      )}
    </div>
  );
}
